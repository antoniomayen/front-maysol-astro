---
import Layout from '../layouts/Layout.astro';
import NavbarPages from '../components/layout/NavbarPages.astro';
import Footer from '../layouts/Footer.astro';
import ContactSection from '../components/sections/ContactSection.astro';
import ProductCard from '../components/ui/ProductCard.astro';
import LoadingSpinner from '../components/ui/LoadingSpinner.astro';
import WhatsAppModal from '../components/ui/WhatsAppModal.astro';
import FloatingWhatsAppButton from '../components/ui/FloatingWhatsAppButton.astro';
import { getProducts, type Product, categoryLabels } from '../lib/strapi';

// Get page and filter parameters
const url = Astro.url;
const pageParam = url.searchParams.get('page') || '1';
const pageSizeParam = url.searchParams.get('size') || '4';
const categoryParam = url.searchParams.get('category') || '';
const availableParam = url.searchParams.get('available') || '';
const searchParam = url.searchParams.get('search') || '';

// Parse and validate parameters
const currentPage = Math.max(1, parseInt(pageParam));
const pageSize = [6, 12, 24].includes(parseInt(pageSizeParam)) ? parseInt(pageSizeParam) : 6;

// Build filters
const filters: any = {};

// Handle multiple categories using $in operator for Strapi
if (categoryParam) {
  const categories = categoryParam.split(',').filter(c => c);
  if (categories.length === 1) {
    filters.category = { $eq: categories[0] };
  } else if (categories.length > 1) {
    // Use $in operator with array for multiple categories
    filters.category = { $in: categories };
  }
}

if (availableParam === 'true') {
  filters.available = { $eq: true };
} else if (availableParam === 'false') {
  filters.available = { $eq: false };
}

if (searchParam) {
  filters.name = { $containsi: searchParam };
}

// Fetch products with pagination and filters
let products: Product[] = [];
let pagination = { page: 1, pageCount: 1, total: 0 };

try {
  // Debug: log filters to see what we're sending
  console.log('Filters being sent:', JSON.stringify(filters, null, 2));
  
  const response = await getProducts({
    filters,
    populate: '*',
    sort: ['featured:desc', 'createdAt:desc'],
    pagination: {
      page: currentPage,
      pageSize: pageSize
    }
  });
  
  products = response.data;
  pagination = response.meta.pagination || { page: 1, pageCount: 1, total: 0 };
} catch (error) {
  console.error('Error fetching products:', error);
}

// Generate page numbers for pagination
const generatePageNumbers = (current: number, total: number) => {
  const pages: (number | string)[] = [];
  const delta = 2;
  
  if (current > delta + 1) {
    pages.push(1);
    if (current > delta + 2) pages.push('...');
  }
  
  for (let i = Math.max(1, current - delta); i <= Math.min(total, current + delta); i++) {
    pages.push(i);
  }
  
  if (current < total - delta) {
    if (current < total - delta - 1) pages.push('...');
    pages.push(total);
  }
  
  return pages;
};

const pageNumbers = generatePageNumbers(currentPage, pagination.pageCount);

// Helper function to build URL with parameters
const buildPageUrl = (page: number, params?: Record<string, string>) => {
  const urlParams = new URLSearchParams();
  urlParams.set('page', page.toString());
  urlParams.set('size', pageSize.toString());
  
  if (categoryParam) urlParams.set('category', categoryParam);
  if (availableParam) urlParams.set('available', availableParam);
  if (searchParam) urlParams.set('search', searchParam);
  
  if (params) {
    Object.entries(params).forEach(([key, value]) => {
      if (value) {
        urlParams.set(key, value);
      } else {
        urlParams.delete(key);
      }
    });
  }
  
  return `/productos?${urlParams.toString()}`;
};

export const prerender = false;
---

<Layout 
  title="Productos - Granjas Maysol" 
  description="Catálogo completo de productos avícolas y porcinos de Granjas Maysol. Gallinas, pollos, cerdos, huevos, alimentos y accesorios de la más alta calidad."
>
  
  <NavbarPages />
  
  <main class="min-h-screen bg-gray-50">
    <!-- Header con búsqueda -->
    <section class="bg-gray-200 border-b border-gray-200 py-8">
      <div class="container-global">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs text-sm mb-6">
          <ul>
            <li><a href="/">Inicio</a></li>
            <li class="font-semibold">Productos</li>
          </ul>
        </div>

        <div class="text-center mb-8">
          <h1 class="text-4xl lg:text-5xl font-bold mb-4 text-gray-900">
            Nuestros Productos
          </h1>
          <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            Explora nuestro catálogo completo de productos de alta calidad para tu producción avícola y porcina
          </p>
        </div>

        <!-- Barra de búsqueda -->
        <div class="flex justify-center mb-6">
          <div class="search-container">
            <input
              type="text"
              id="search-input"
              placeholder="Buscar un producto..."
              value={searchParam}
              class="search-input"
            />
            {searchParam && (
              <button id="clear-search" class="search-clear" aria-label="Limpiar búsqueda">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            )}
            <button id="search-button" class="search-button" aria-label="Buscar">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Filtros activos -->
        {(categoryParam || searchParam) && (
          <div class="active-filters flex justify-center">
            {searchParam && (
              <div class="filter-chip">
                <span>Búsqueda: "{searchParam}"</span>
                <a href={buildPageUrl(1, { search: '' })} class="filter-chip-remove">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </a>
              </div>
            )}
            {categoryParam && categoryParam.split(',').filter(c => c).map(cat => (
              <div class="filter-chip">
                <span>{categoryLabels[cat] || cat}</span>
                <a 
                  href={(() => {
                    const cats = categoryParam.split(',').filter(c => c && c !== cat);
                    return buildPageUrl(1, { category: cats.join(',') || '' });
                  })()}
                  class="filter-chip-remove"
                >
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </a>
              </div>
            ))}
          </div>
        )}
      </div>
    </section>

    <!-- Contenido principal -->
    <section class="bg-white border-b border-gray-200 py-8">
      <div class="container-global">
        <div class="flex flex-col lg:flex-row gap-8">
          <!-- Sidebar de filtros (desktop) -->
          <aside class="hidden lg:block w-72 flex-shrink-0">
            <div class="filters-container sticky top-4">
              <h2 class="text-lg font-bold mb-4">Filtros</h2>
              
              <!-- Filtro por categoría -->
              <div class="filter-group">
                <div class="filter-label">
                  <span>Categoría</span>
                  <button class="filter-toggle expanded" data-target="category-options">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                </div>
                <div id="category-options" class="filter-options expanded">
                  <!-- Opción "Todas" siempre visible al inicio -->
                  <label class="filter-option">
                    <div class={`filter-checkbox ${!categoryParam ? 'checked' : ''}`}></div>
                    <span class="filter-option-label font-semibold">Todas las categorías</span>
                    <input 
                      type="checkbox" 
                      id="category-all"
                      value=""
                      checked={!categoryParam}
                      class="hidden"
                      data-filter="category-all"
                    />
                  </label>
                  
                  <!-- Separador visual -->
                  <div class="border-t border-gray-200 my-2"></div>
                  
                  <!-- Categorías específicas con checkboxes -->
                  {Object.entries(categoryLabels).map(([value, label]) => {
                    const selectedCategories = categoryParam ? categoryParam.split(',') : [];
                    const isChecked = selectedCategories.includes(value);
                    return (
                      <label class="filter-option">
                        <div class={`filter-checkbox ${isChecked ? 'checked' : ''}`}></div>
                        <span class="filter-option-label">{label}</span>
                        <input 
                          type="checkbox" 
                          value={value}
                          checked={isChecked}
                          class="hidden"
                          data-filter="category"
                          data-category={value}
                        />
                      </label>
                    );
                  })}
                </div>
              </div>

            </div>
          </aside>

          <!-- Productos -->
          <div class="flex-1 products-main-container">
            <!-- Info de resultados -->
            <div class="flex justify-between items-center mb-6 results-info">
              <div class="text-sm text-gray-600">
                {products.length > 0 ? (
                  <span>
                    Mostrando {((currentPage - 1) * pageSize + 1)} - {Math.min(currentPage * pageSize, pagination.total)} de {pagination.total} productos
                  </span>
                ) : (
                  <span>No se encontraron productos</span>
                )}
              </div>
              
              <!-- Selector de cantidad por página -->
              <div class="flex items-center gap-2 page-size-selector">
                <label for="page-size" class="text-sm text-gray-600">Mostrar:</label>
                <select 
                  id="page-size"
                  class="select select-bordered select-sm bg-white"
                  value={pageSize}
                >
                  <option value="6" selected={pageSize === 6}>6</option>
                  <option value="12" selected={pageSize === 12}>12</option>
                  <option value="24" selected={pageSize === 24}>24</option>
                </select>
              </div>
            </div>

            {products.length > 0 ? (
              <>
                <!-- Contenedor principal -->
                <div class="products-wrapper mb-12" id="products-container">
                  <!-- Loading spinner (se oculta cuando los productos cargan) -->
                  <div class="loading-container hidden">
                    <LoadingSpinner size="small" centered={true} />
                  </div>
                  
                  <!-- Grid de productos -->
                  <div class="products-grid">
                    {products.map((product) => (
                      <ProductCard product={product} />
                    ))}
                  </div>
                </div>

                <!-- Paginación -->
                {pagination.pageCount > 1 && (
                  <div class="pagination-container pagination-alignment">
                    <a 
                      href={currentPage > 1 ? buildPageUrl(currentPage - 1) : '#'}
                      class={`pagination-button pagination-arrow ${currentPage <= 1 ? 'disabled' : ''}`}
                      aria-label="Página anterior"
                    >
                      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                      </svg>
                    </a>

                    {pageNumbers.map((pageNum) => (
                      pageNum === '...' ? (
                        <span class="pagination-ellipsis">...</span>
                      ) : (
                        <a 
                          href={buildPageUrl(pageNum as number)}
                          class={`pagination-button ${currentPage === pageNum ? 'active' : ''}`}
                          aria-label={`Página ${pageNum}`}
                        >
                          {pageNum}
                        </a>
                      )
                    ))}

                    <a 
                      href={currentPage < pagination.pageCount ? buildPageUrl(currentPage + 1) : '#'}
                      class={`pagination-button pagination-arrow ${currentPage >= pagination.pageCount ? 'disabled' : ''}`}
                      aria-label="Página siguiente"
                    >
                      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  </div>
                )}
              </>
            ) : (
              <!-- Estado vacío -->
              <div class="text-center py-20">
                <div class="max-w-md mx-auto">
                  <svg class="w-20 h-20 mx-auto text-gray-400 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-2M4 13h2m13-8V4a1 1 0 00-1-1H7a1 1 0 00-1 1v1m8 0V4.5"></path>
                  </svg>
                  <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    No se encontraron productos
                  </h2>
                  <p class="text-gray-600 mb-8">
                    {searchParam ? 
                      `No encontramos productos que coincidan con "${searchParam}". Intenta con otros términos de búsqueda.` :
                      'No hay productos disponibles con los filtros seleccionados. Intenta ajustar los filtros o contacta con nosotros.'}
                  </p>
                  <button id="empty-whatsapp" class="btn btn-success btn-lg">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766.001-3.187-2.575-5.77-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.751-2.874-2.502-2.961-2.617-.087-.116-.708-.94-.708-1.793s.448-1.273.607-1.446c.159-.173.346-.217.462-.217l.332.006c.106.005.249-.04.39.298.144.347.491 1.2.534 1.287.043.087.072.188.014.304-.058.116-.087.188-.173.289l-.26.304c-.087.086-.177.18-.076.354.101.174.449.741.964 1.201.662.591 1.221.774 1.394.86s.274.072.376-.043c.101-.116.433-.506.549-.68.116-.173.231-.145.39-.087s1.011.477 1.184.564.289.13.332.202c.045.072.045.419-.1.824z"/>
                    </svg>
                    Consultar Disponibilidad
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- Botón de filtros móvil -->
    <button id="mobile-filter-button" class="mobile-filter-button lg:hidden">
      <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
      </svg>
    </button>
  </main>

  <!-- Sección de Contacto -->
  <ContactSection />

  <!-- Footer -->
  <Footer />

  <!-- WhatsApp Components -->
  <WhatsAppModal />
  <FloatingWhatsAppButton />
</Layout>

<style>
  @import '../styles/productos.css';
</style>

<script>
  // Búsqueda
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchButton = document.getElementById('search-button');
  const clearButton = document.getElementById('clear-search');

  // Función para mostrar skeleton loader con delay SOLO durante navegación
  let loaderTimeout: number | null = null;
  let isNavigating = false;
  
  const showSkeletonLoader = () => {
    // Marcar que estamos navegando
    isNavigating = true;
    
    // Solo mostrar el loader si la navegación tarda más de 200ms
    loaderTimeout = window.setTimeout(() => {
      const productsContainer = document.getElementById('products-container');
      if (productsContainer && isNavigating) {
        productsContainer.classList.add('loading');
      }
    }, 200); // 200ms delay antes de mostrar el loader
  };
  
  // Cancelar el loader si la página carga rápido
  const cancelSkeletonLoader = () => {
    isNavigating = false;
    if (loaderTimeout) {
      window.clearTimeout(loaderTimeout);
      loaderTimeout = null;
    }
    // Asegurar que el loader esté oculto
    const productsContainer = document.getElementById('products-container');
    if (productsContainer) {
      productsContainer.classList.remove('loading');
    }
  };

  const performSearch = () => {
    const searchValue = searchInput?.value.trim();
    const url = new URL(window.location.href);
    
    if (searchValue) {
      url.searchParams.set('search', searchValue);
    } else {
      url.searchParams.delete('search');
    }
    url.searchParams.set('page', '1');
    showSkeletonLoader();
    window.location.href = url.toString();
  };

  searchButton?.addEventListener('click', performSearch);
  searchInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      performSearch();
    }
  });

  clearButton?.addEventListener('click', () => {
    const url = new URL(window.location.href);
    url.searchParams.delete('search');
    url.searchParams.set('page', '1');
    showSkeletonLoader();
    window.location.href = url.toString();
  });

  // Cambio de tamaño de página
  const pageSizeSelect = document.getElementById('page-size') as HTMLSelectElement;
  pageSizeSelect?.addEventListener('change', (e) => {
    const select = e.target as HTMLSelectElement;
    const url = new URL(window.location.href);
    url.searchParams.set('size', select.value);
    url.searchParams.set('page', '1');
    showSkeletonLoader();
    window.location.href = url.toString();
  });

  // Filtros con checkboxes para múltiple selección
  const categoryCheckboxes = document.querySelectorAll('input[data-filter="category"]');
  const allCategoriesCheckbox = document.getElementById('category-all') as HTMLInputElement;
  
  // Manejar checkbox "Todas las categorías"
  allCategoriesCheckbox?.addEventListener('change', () => {
    const url = new URL(window.location.href);
    url.searchParams.delete('category');
    url.searchParams.set('page', '1');
    showSkeletonLoader();
    window.location.href = url.toString();
  });
  
  // Manejar checkboxes de categorías individuales
  categoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const value = target.value;
      const url = new URL(window.location.href);
      const currentCategories = url.searchParams.get('category')?.split(',').filter(c => c) || [];
      
      if (target.checked) {
        // Agregar categoría
        if (!currentCategories.includes(value)) {
          currentCategories.push(value);
        }
      } else {
        // Quitar categoría
        const index = currentCategories.indexOf(value);
        if (index > -1) {
          currentCategories.splice(index, 1);
        }
      }
      
      // Actualizar URL
      if (currentCategories.length > 0) {
        url.searchParams.set('category', currentCategories.join(','));
      } else {
        url.searchParams.delete('category');
      }
      
      url.searchParams.set('page', '1');
      showSkeletonLoader();
      window.location.href = url.toString();
    });
  });

  // Toggle de grupos de filtros
  const filterToggles = document.querySelectorAll('.filter-toggle');
  filterToggles.forEach(toggle => {
    toggle.addEventListener('click', () => {
      const target = toggle.getAttribute('data-target');
      const options = document.getElementById(target!);
      
      toggle.classList.toggle('expanded');
      options?.classList.toggle('expanded');
    });
  });

  // WhatsApp para estado vacío
  document.getElementById('empty-whatsapp')?.addEventListener('click', () => {
    const modal = document.getElementById('whatsapp-modal') as HTMLDialogElement;
    if (modal) {
      const messageTextarea = modal.querySelector('textarea[name="message"]') as HTMLTextAreaElement;
      if (messageTextarea) {
        messageTextarea.value = 'Hola, me gustaría consultar sobre la disponibilidad de productos.';
      }
      modal.showModal();
    }
  });

  // Mobile filter modal (placeholder para futura implementación)
  document.getElementById('mobile-filter-button')?.addEventListener('click', () => {
    alert('Los filtros móviles se mostrarán aquí. Por ahora, usa la versión de escritorio.');
  });

  // Agregar skeleton loader a los links de paginación
  const paginationLinks = document.querySelectorAll('.pagination-button:not(.disabled)');
  paginationLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      const href = (e.currentTarget as HTMLAnchorElement).href;
      if (href && !href.includes('#')) {
        e.preventDefault();
        showSkeletonLoader();
        setTimeout(() => {
          window.location.href = href;
        }, 50); // Pequeño delay para asegurar que se muestre el loader
      }
    });
  });

  // Agregar skeleton loader a los chips de filtros activos
  const filterChipLinks = document.querySelectorAll('.filter-chip-remove');
  filterChipLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = (e.currentTarget as HTMLAnchorElement).href;
      showSkeletonLoader();
      setTimeout(() => {
        window.location.href = href;
      }, 50);
    });
  });

  // IMPORTANTE: Asegurar que el loader NO aparezca al cargar la página inicialmente
  // Solo debe aparecer cuando el usuario interactúa con filtros/navegación
  document.addEventListener('DOMContentLoaded', () => {
    // Cancelar cualquier loader y asegurar que esté oculto
    cancelSkeletonLoader();
    
    // Forzar la eliminación de la clase loading
    const productsContainer = document.getElementById('products-container');
    if (productsContainer) {
      productsContainer.classList.remove('loading');
      // Asegurar que los productos sean visibles
      const productsGrid = productsContainer.querySelector('.products-grid');
      if (productsGrid) {
        (productsGrid as HTMLElement).style.opacity = '1';
      }
    }
  });
  
  // Limpiar al salir de la página
  window.addEventListener('beforeunload', () => {
    cancelSkeletonLoader();
  });
  
  // También asegurar al cargar la ventana (por si acaso)
  window.addEventListener('load', () => {
    cancelSkeletonLoader();
  });
</script>